<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FindMyDesk - UBC Study Spots</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Montserrat:wght@700&display=swap"
          rel="stylesheet">
    <style>
        body {
          margin: 0;
          font-family: 'Roboto', sans-serif;
          display: flex;
        }

        /* Sidebar styles */
        #sidebar {
          width: 350px;
          height: 100vh;
          background-color: #ffffff;
          padding: 20px;
          box-shadow: 2px 0px 5px rgba(0,0,0,0.1);
          overflow-y: auto;
        }

        #sidebar h2 {
          margin-top: 0;
          font-size: 24px;
          font-family: 'Montserrat', sans-serif;
          color: #2c3e50;
        }

        #sidebar h3 {
          font-size: 16px;
          color: #34495e;
          margin-bottom: 10px;
        }

        .filter-group {
          margin-bottom: 20px;
        }

        .filter-group label {
          display: block;
          margin: 8px 0;
        }

        button {
          width: 100%;
          padding: 10px;
          margin-top: 10px;
          color: white;
          border: none;
          cursor: pointer;
          border-radius: 5px;
          font-weight: 500;
        }

        button#showAllBtn {
          background-color: #27ae60;
        }
        button#showAllBtn:hover { background-color: #229954; }

        button#applyBtn { background-color: #3498db; }
        button#applyBtn:hover { background-color: #2980b9; }

        button.reset { background-color: #777; }
        button.reset:hover { background-color: #555; }

        button#detectLocationBtn {
          background-color: #9b59b6;
          margin-top: 5px;
        }
        button#detectLocationBtn:hover { background-color: #8e44ad; }

        /* Map container */
        #map { flex: 1; height: 100vh; }

        /* Toggle switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
          position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
          background-color: #ccc; transition: .4s; border-radius: 24px;
        }
        .slider:before {
          position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
          background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #3498db; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Radio buttons */
        .radio-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-label { display: flex; align-items: center; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; cursor: pointer; }
        .radio-label input[type="radio"] { margin-right: 8px; }

        /* Amenities */
        .amenity-btn {
          padding: 8px 12px; border: 1px solid #3498db; border-radius: 20px;
          background-color: #ecf0f1; cursor: pointer; font-size: 14px; color: #2c3e50;
          text-align: left; margin-bottom: 8px;
        }
        .amenity-btn.active { background-color: #3498db; color: white; }

        /* Checkboxes */
        .checkbox-label {
          display: flex; align-items: center; padding: 8px 12px; border: 1px solid #3498db;
          border-radius: 20px; background-color: #ecf0f1; cursor: pointer; margin-bottom: 8px;
        }
        .checkbox-label.checked { background-color: #3498db; color: white; }

        .time-selects {
          display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }

        select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #bdc3c7; }
        input[type=range] { width: 100%; margin-top: 5px; }

        .alert {
          padding: 12px; margin-bottom: 15px; border-radius: 6px; font-size: 14px; display: none;
        }
        .alert.show { display: block; }
        .alert.error { background-color: #fadbd8; color: #c0392b; border: 1px solid #e74c3c; }
        .alert.success { background-color: #d5f4e6; color: #27ae60; border: 1px solid #27ae60; }
        .alert.warning { background-color: #fcf3cf; color: #d68910; border: 1px solid #f39c12; }

        .location-info { font-size: 12px; color: #7f8c8d; margin-top: 5px; font-style: italic; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>FindMyDesk</h2>
    <div id="alertBox" class="alert"></div>


    <div class="filter-group">
        <h3>Your Location</h3>
        <button id="detectLocationBtn">üìç Detect My Location</button>
        <div class="location-info" id="locationInfo">Click map or detect location</div>
    </div>

    <button id="showAllBtn">Show All Study Spots</button>
    <button class="reset" id="removeStudySpotsBtn">Remove All Study Spots</button>

    <h3 style="margin-top: 20px;">Filters</h3>


    <div class="filter-group">
        <h3>Max Distance</h3>
        <input type="range" min="50" max="3000" value="500" step="50" id="distanceSlider">
        <span id="distanceValue">500</span> m
    </div>

    <div class="filter-group">
        <h3>Noise Level</h3>
        <div class="radio-group">
            <label class="radio-label"><input type="radio" name="noise" value="silent" checked>
                <span>Silent</span></label>
            <label class="radio-label"><input type="radio" name="noise" value="moderate"> <span>Moderate</span></label>
            <label class="radio-label"><input type="radio" name="noise" value="loud"> <span>Loud</span></label>
            <label class="radio-label"><input type="radio" name="noise" value="any"> <span>No Preference</span></label>
        </div>
    </div>


    <div class="filter-group">
        <h3>Location Type</h3>
        <div class="radio-group">
            <label class="radio-label"><input type="radio" name="location" value="indoor" checked>
                <span>Indoor</span></label>
            <label class="radio-label"><input type="radio" name="location" value="outdoor"> <span>Outdoor</span></label>
            <label class="radio-label"><input type="radio" name="location" value="both">
                <span>No Preference</span></label>
        </div>
    </div>


    <div class="filter-group">
        <h3>UBC Card Access</h3>
        <label class="switch"><input type="checkbox" id="accessToggle"><span class="slider"></span></label>
        <span style="margin-left: 10px;">Required</span>
    </div>

    <div class="filter-group">
        <h3>Amenities</h3>
        <div id="amenitiesContainer">
            <div class="amenity-btn" data-value="washrooms">Washrooms Nearby</div>
            <div class="amenity-btn" data-value="wifi">Wi-Fi</div>
            <div class="amenity-btn" data-value="food_drink_allowed">Food/Drinks Allowed</div>
            <div class="amenity-btn" data-value="private_rooms">Private Rooms</div>
            <div class="amenity-btn" data-value="projectors">Student-Accessible Projectors</div>
        </div>
    </div>

    <div class="filter-group">
        <h3>Type of Space</h3>
        <div id="spaceTypeContainer">
            <label class="checkbox-label"><input type="checkbox" value="open_area">
                <span>Open Area / Lounge</span></label>
            <label class="checkbox-label"><input type="checkbox" value="quiet_room">
                <span>Quiet Room / Silent Study</span></label>
            <label class="checkbox-label"><input type="checkbox" value="group_study">
                <span>Group Study Room</span></label>
            <label class="checkbox-label"><input type="checkbox" value="outdoor_seating">
                <span>Outdoor Seating</span></label>
            <label class="checkbox-label"><input type="checkbox" value="library_classroom">
                <span>Library / Classroom</span></label>
        </div>
    </div>


    <div class="filter-group">
        <h3>Hours of Operation</h3>
        <div class="time-selects">
            <div><label style="font-size: 13px;">Opens After</label><select id="openTimeSelect"></select></div>
            <div><label style="font-size: 13px;">Closes After</label><select id="closeTimeSelect"></select></div>
        </div>
    </div>

    <button id="applyBtn">Apply Filters</button>
    <button class="reset" id="resetBtn">Reset</button>
</div>

<div id="map"></div>

<script>

    // Configuration


    const API_BASE_URL = "http://localhost:8080/api";
    const UBC_BOUNDARIES = { NORTH: 49.2756, SOUTH: 49.2596, WEST: -123.2630, EAST: -123.2340 };
    let map, markers = [], allStudySpots = [], userLocation = { lat: 49.2668, lng: -123.2500 }, userMarker = null, infoWindows = [];

    // Format time
    function formatTime(time) {
      if (!time) return 'N/A';
      if (typeof time === 'string') return time.substring(0,5);
      if (Array.isArray(time)) return `${String(time[0]).padStart(2,'0')}:${String(time[1]).padStart(2,'0')}`;
      if (time.hour !== undefined && time.minute !== undefined) return `${String(time.hour).padStart(2,'0')}:${String(time.minute).padStart(2,'0')}`;
      return 'N/A';
    }

    // UBC boundary check
    function isWithinUBCCampus(lat,lng) {
      return lat >= UBC_BOUNDARIES.SOUTH && lat <= UBC_BOUNDARIES.NORTH && lng >= UBC_BOUNDARIES.WEST && lng <= UBC_BOUNDARIES.EAST;
    }

    function updateLocationInfo(lat,lng,source) {
      document.getElementById('locationInfo').textContent = `üìç ${source} (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
    }

    function setUserLocationMarker(lat,lng){
      if(userMarker) userMarker.setMap(null);
      userMarker = new google.maps.Marker({
        position: {lat,lng}, map, title:"Your Location",
        icon: {url:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png"}, zIndex:1000
      });
      const iw = new google.maps.InfoWindow({content:'<div style="padding: 5px;"><strong>Your Location</strong></div>'});
      userMarker.addListener('click',()=>iw.open(map,userMarker));
    }

    // Detect GPS location
    function detectUserLocation(){
      if(!navigator.geolocation){ showAlert('Geolocation not supported','warning',true); return; }
      showAlert('Detecting your location...','success',false);
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const lat=pos.coords.latitude,lng=pos.coords.longitude;
          if(isWithinUBCCampus(lat,lng)){
            userLocation={lat,lng};
            setUserLocationMarker(lat,lng);
            map.setCenter(new google.maps.LatLng(lat,lng)); map.setZoom(16);
            updateLocationInfo(lat,lng,'GPS detected'); showAlert('‚úì Location detected successfully!','success',false);
          }else{
            showAlert('Outside campus. Using default location.','warning',true);
            updateLocationInfo(userLocation.lat,userLocation.lng,'Default (outside campus)');
          }
        },
        (err)=>{
          console.error(err); let msg='Could not detect location. ';
          if(err.code===1) msg+='Enable location permissions.'; else if(err.code===2) msg+='Location unavailable.'; else msg+='Request timed out.';
          showAlert(msg+' Using default location.','warning',true);
          updateLocationInfo(userLocation.lat,userLocation.lng,'Default');
        },
        {enableHighAccuracy:true,timeout:10000,maximumAge:0}
      );
    }
    document.getElementById("removeStudySpotsBtn").addEventListener("click", () => {
      // Remove only study spot markers, not user location
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      // Close all info windows
      infoWindows.forEach(iw => iw.close());
      infoWindows = [];

      showAlert("All study spots removed from map.", "success", false);
    });

    function myMap(){
      const mapCanvas=document.getElementById("map");
      map=new google.maps.Map(mapCanvas,{center:{lat:49.2606,lng:-123.2460},zoom:15,mapTypeControl:true,streetViewControl:false});
      setUserLocationMarker(userLocation.lat,userLocation.lng);
      updateLocationInfo(userLocation.lat,userLocation.lng,'Default');

      map.addListener('click',event=>{
        const lat=event.latLng.lat(),lng=event.latLng.lng();
        if(isWithinUBCCampus(lat,lng)){ userLocation={lat,lng}; setUserLocationMarker(lat,lng); updateLocationInfo(lat,lng,'Click on map'); showAlert('‚úì Location set. Click Apply to update results.','success',false);}
        else showAlert('Click within UBC boundaries','warning',true);
      });

    }

    // Load all study spots
    async function loadAllStudySpots(){
      try{
        const res=await fetch(`${API_BASE_URL}/studyspots/all`);
        if(!res.ok) throw new Error('Data unavailable.');
        allStudySpots=await res.json();
        displayMarkersOnMap(allStudySpots,false);
        showAlert('Loaded '+allStudySpots.length+' study spots','success',false);
      }catch(e){ console.error(e); showAlert('Data unavailable.','error',true);}
    }

    // Display markers with ranking
    function getMarkerColor(rank){ return rank===0?'green':rank===1?'yellow':rank===2?'orange':'red'; }
    function displayMarkersOnMap(spots,showRanking){
      infoWindows.forEach(iw=>iw.close()); infoWindows=[]; markers.forEach(m=>m.setMap(null)); markers=[];
      const locationCounts={};
      spots.forEach((spot,index)=>{
        const locKey=`${spot.latitude.toFixed(4)},${spot.longitude.toFixed(4)}`;
        if(!locationCounts[locKey]) locationCounts[locKey]=0;
        const offsetIndex=locationCounts[locKey]; locationCounts[locKey]++;
        const lat=spot.latitude+(offsetIndex*0.0001), lng=spot.longitude+(offsetIndex*0.0001);
        const markerConfig={position:{lat,lng},map,title:spot.name};
        if(showRanking && index<5){
          markerConfig.label={text:`${index+1}`,color:'white',fontWeight:'bold',fontSize:'14px'};
          markerConfig.icon={url:`http://maps.google.com/mapfiles/ms/icons/${getMarkerColor(index)}-dot.png`,labelOrigin:new google.maps.Point(16,10)};
        }
        const marker=new google.maps.Marker(markerConfig);
        const content=`<div style="padding: 10px; max-width: 250px;">
          <h3 style="margin:0 0 10px 0;color:#2c3e50;">${spot.name||'Unknown'}</h3>
          ${showRanking && spot.score!==undefined?`<p style="margin:5px 0;padding:5px;background:#3498db;color:white;border-radius:3px;text-align:center;"><strong>Match Score: ${spot.score.toFixed(1)}%</strong></p>`:''}
          <p style="margin:5px 0;"><strong>Type:</strong> ${spot.spaceType||'N/A'}</p>
          <p style="margin:5px 0;"><strong>Noise:</strong> ${spot.noiseLevel||'N/A'}</p>
          <p style="margin:5px 0;"><strong>Hours:</strong> ${formatTime(spot.openTime)} - ${formatTime(spot.closeTime)}</p>
          <p style="margin:5px 0;"><strong>Location:</strong> ${spot.indoorOutdoor||'N/A'}</p>
          <p style="margin:5px 0;"><strong>Access:</strong> ${spot.accessRequired?'UBC Card Required':'Open to Public'}</p>
        </div>`;
        const infoWindow=new google.maps.InfoWindow({content});
        infoWindows.push(infoWindow);
        marker.addListener('click',()=>{infoWindows.forEach(iw=>iw.close()); map.setZoom(17); map.setCenter(marker.getPosition()); infoWindow.open(map,marker);});
        markers.push(marker);
      });
    }

    // Calculate distances
    function calculateDistances(spots){
      const distances={};
      spots.forEach(s=>{
        distances[s.id]=google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(userLocation.lat,userLocation.lng),
          new google.maps.LatLng(s.latitude,s.longitude)
        );
      });
      return distances;
    }

    // Populate time selects
    const openTimeSelect=document.getElementById("openTimeSelect");
    const closeTimeSelect=document.getElementById("closeTimeSelect");
    for(let i=0;i<=23;i++){ const t=(i<10?'0':'')+i+":00"; openTimeSelect.innerHTML+='<option value="'+t+'">'+t+'</option>'; closeTimeSelect.innerHTML+='<option value="'+t+'">'+t+'</option>'; }
    openTimeSelect.value="08:00"; closeTimeSelect.value="21:00";

    // Distance slider
    const distanceSlider=document.getElementById("distanceSlider");
    const distanceValue=document.getElementById("distanceValue");
    distanceSlider.addEventListener("input",()=>distanceValue.textContent=distanceSlider.value);

    // Amenity buttons
    const amenityBtns=document.querySelectorAll(".amenity-btn");
    amenityBtns.forEach(btn=>btn.addEventListener("click",()=>btn.classList.toggle("active")));

    // Space type checkboxes
    const spaceTypeLabels=document.querySelectorAll("#spaceTypeContainer .checkbox-label");
    spaceTypeLabels.forEach(label=>{ const cb=label.querySelector('input[type="checkbox"]'); cb.addEventListener("change",()=>label.classList.toggle("checked",cb.checked)); });

    // Alerts
    function showAlert(msg,type,persist){ const a=document.getElementById("alertBox"); a.textContent=msg; a.className="alert "+type+" show"; if(!persist && type==='success') setTimeout(()=>a.classList.remove('show'),5000);}
    function hideAlert(){ document.getElementById("alertBox").classList.remove('show'); }

    // Filter validation
    function validateFilters(noiseLevel,locationType,selectedSpaceTypes,openTime,closeTime){
      const errors=[];
      if(noiseLevel==='Silent' && locationType==='Outdoor') errors.push('Silent noise level not compatible with Outdoor location.');
      if(parseInt(closeTime.split(':')[0]) <= parseInt(openTime.split(':')[0])) errors.push('Closing time must be after opening time.');
      if(selectedSpaceTypes.includes('outdoor_seating') && noiseLevel==='Silent') errors.push('Outdoor Seating not compatible with Silent noise level.');
      return errors;
    }

    // Get filter data
    function getFilterData(showAll=false){
      const selectedAmenities=Array.from(document.querySelectorAll(".amenity-btn.active")).map(b=>b.dataset.value);
      const selectedSpaceTypes=Array.from(document.querySelectorAll("#spaceTypeContainer input:checked")).map(cb=>cb.value);
      const noiseLevel=document.querySelector('input[name="noise"]:checked').value;
      const locationType=document.querySelector('input[name="location"]:checked').value;
      const distances=allStudySpots.length>0?calculateDistances(allStudySpots):{};
      return {showAll, noiseLevel:noiseLevel.charAt(0).toUpperCase()+noiseLevel.slice(1), indoorOutdoor: locationType==='both'?'Any':locationType.charAt(0).toUpperCase()+locationType.slice(1), selectedAmenities, selectedSpaceTypes, accessRequired:document.getElementById("accessToggle").checked, maxDistance:parseInt(distanceSlider.value), openTime:openTimeSelect.value, closeTime:closeTimeSelect.value, distancesFromUser:distances};
    }

    // Event listeners
    document.getElementById("detectLocationBtn").addEventListener("click",detectUserLocation);
    document.getElementById("showAllBtn").addEventListener("click",async function(){
      hideAlert();
      const allSpotsRequest=getFilterData(true);
      try{
        const res=await fetch(`${API_BASE_URL}/preferences/apply`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(allSpotsRequest)});
        if(!res.ok) throw new Error('Data unavailable.');
        const scoredSpots=await res.json();
        displayMarkersOnMap(scoredSpots,false);
        showAlert(`Showing all ${scoredSpots.length} study spots`,'success',false);
      }catch(e){ console.error(e); showAlert('Data unavailable.','error',true); }
    });

    document.getElementById("applyBtn").addEventListener("click",async function(){
      const filters=getFilterData(false);
      const errors=validateFilters(filters.noiseLevel,filters.indoorOutdoor,filters.selectedSpaceTypes,filters.openTime,filters.closeTime);
      if(errors.length>0){ showAlert(errors[0],'error',true); return; }
      hideAlert();
      try{
        const res=await fetch(`${API_BASE_URL}/preferences/apply`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(filters)});
        if(!res.ok) throw new Error('Data unavailable.');
        const scoredSpots=await res.json();
        if(scoredSpots.length===0){ showAlert('No study spots match your filters.','warning',true); markers.forEach(m=>m.setMap(null)); markers=[]; }
        else{ displayMarkersOnMap(scoredSpots.slice(0,5),true); showAlert(`Showing top ${Math.min(5,scoredSpots.length)} matching study spots!`,'success',false);}
      }catch(e){ console.error(e); showAlert('Data unavailable.','error',true); }
    });

    document.getElementById("resetBtn").addEventListener("click",async function(){
      hideAlert();
      distanceSlider.value=500; distanceValue.textContent=500;
      document.querySelector('input[name="noise"][value="silent"]').checked=true;
      document.querySelector('input[name="location"][value="indoor"]').checked=true;
      document.getElementById("accessToggle").checked=false;
      amenityBtns.forEach(b=>b.classList.remove("active"));
      spaceTypeLabels.forEach(l=>{l.querySelector('input').checked=false;l.classList.remove("checked");});
      openTimeSelect.value="08:00"; closeTimeSelect.value="21:00";
      try{
        const res=await fetch(`${API_BASE_URL}/preferences/reset`,{method:'POST'});
        if(!res.ok) throw new Error('Data unavailable.');
        showAlert("Filters reset. Showing all study spots.","success",false);
        await loadAllStudySpots();
      }catch(e){ console.error(e); showAlert('Data unavailable.','error',true); }
    });
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbxQstv8REK3ZFopWeuVwT6ePG95r5Vy8&libraries=geometry&callback=myMap"
        async defer></script>

</body>
</html>
